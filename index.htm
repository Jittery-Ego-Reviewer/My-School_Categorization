<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆ‘çš„æ ¡åœ’åˆ†é¡éŠæˆ²</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .animate-pop { animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      20%, 60% { transform: translateX(-8px); }
      40%, 80% { transform: translateX(8px); }
    }
    .animate-shake { animation: shake 0.4s ease-in-out; }
    
    .drag-overlay {
      position: fixed;
      pointer-events: none;
      z-index: 9999;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: scale(1.1) rotate(-3deg);
      transition: transform 0.1s;
    }
  </style>
</head>
<body class="h-[100dvh] bg-[#f0f9ff] font-sans flex flex-col overflow-hidden text-slate-800 overscroll-none">

  <!-- é ‚éƒ¨æ¨™é¡Œ -->
  <header class="bg-white shadow-sm py-4 px-6 flex justify-between items-center z-10 shrink-0 select-none">
    <h1 class="text-3xl font-bold text-sky-600 flex items-center gap-3">
      ğŸ« æˆ‘çš„æ ¡åœ’åˆ†é¡éŠæˆ²
    </h1>
    <div class="flex items-center gap-4">
      <div class="text-lg font-medium text-slate-600 bg-slate-100 px-4 py-2 rounded-full">
        é‚„æœ‰ <span id="queue-count" class="text-sky-600 font-bold text-2xl">0</span> å€‹è©èª
      </div>
      <button 
        onclick="initGame()"
        class="p-2 rounded-full hover:bg-slate-100 text-slate-500 transition-colors cursor-pointer"
        title="é‡æ–°é–‹å§‹"
      >
        <i class="fa-solid fa-rotate-right text-xl"></i>
      </button>
    </div>
  </header>

  <!-- æç¤ºè¨Šæ¯ -->
  <div id="feedback-message" class="hidden absolute top-20 left-1/2 -translate-x-1/2 z-50 bg-green-500 text-white px-6 py-3 rounded-full shadow-lg font-bold text-xl flex items-center gap-2 animate-bounce">
    <i class="fa-solid fa-check text-xl"></i>
    <span id="feedback-text"></span>
  </div>

  <!-- éŠæˆ²ä¸»è¦å€åŸŸ -->
  <main class="flex-1 flex flex-col p-4 md:p-6 gap-6 overflow-hidden h-full select-none">
    
    <!-- åˆ†é¡æ”¾ç½®å€ (ä¸ŠåŠéƒ¨) -->
    <div id="categories-container" class="grid grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 flex-1 overflow-y-auto pb-4">
      <!-- Categories rendered by JS -->
    </div>

    <!-- è©èªåº« (ä¸‹åŠéƒ¨) -->
    <div class="h-48 md:h-56 bg-white rounded-3xl shadow-xl border-4 border-sky-200 p-4 md:p-6 flex flex-col shrink-0 relative">
      <div class="absolute -top-4 left-1/2 -translate-x-1/2 bg-sky-500 text-white px-6 py-1 rounded-full font-bold shadow-md whitespace-nowrap">
        è©èªåº« (è«‹æ‹–æ›³åˆ°ä¸Šæ–¹çš„æ­£ç¢ºåˆ†é¡)
      </div>
      
      <div id="word-pool" class="flex-1 flex justify-center items-center gap-4 md:gap-8 flex-wrap">
        <!-- Active words rendered by JS -->
      </div>

      <!-- æ–°å¢æŒ‰éˆ• -->
      <button
        onclick="openAddModal()"
        class="absolute -right-2 -bottom-2 md:right-4 md:-bottom-6 bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-full shadow-lg transition-transform hover:scale-110 flex items-center justify-center border-4 border-white cursor-pointer"
        title="è€å¸«æ–°å¢è©èª"
      >
        <i class="fa-solid fa-plus text-2xl"></i>
      </button>
    </div>

  </main>

  <!-- æ‹–æ›³æ™‚çš„æ‡¸æµ®å…ƒç´  -->
  <div id="drag-overlay" class="hidden drag-overlay bg-yellow-300 text-yellow-900 border-b-8 border-yellow-500 px-6 py-4 md:px-8 md:py-5 rounded-2xl font-black text-2xl md:text-3xl flex items-center justify-center">
  </div>

  <!-- æ–°å¢è©èªå°è©±æ¡† (Teacher Tool) -->
  <div id="add-modal" class="hidden fixed inset-0 bg-slate-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-8 w-full max-w-md animate-pop">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
          <i class="fa-solid fa-plus text-purple-500"></i> åŠ å…¥æ–°è©èª
        </h2>
        <button 
          onclick="closeAddModal()"
          class="p-2 bg-slate-100 hover:bg-slate-200 rounded-full text-slate-500 cursor-pointer"
        >
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </div>
      
      <form id="add-word-form" class="space-y-6">
        <div>
          <label class="block text-lg font-bold text-slate-700 mb-2">è©èªåç¨±</label>
          <input
            type="text"
            id="new-word-input"
            placeholder="ä¾‹å¦‚ï¼šåœ–æ›¸ç®¡ç†å“¡"
            class="w-full text-2xl p-4 border-4 border-slate-200 rounded-2xl focus:border-purple-400 focus:outline-none transition-colors"
          />
        </div>
        
        <div>
          <label class="block text-lg font-bold text-slate-700 mb-2">é¸æ“‡æ­£ç¢ºçš„åˆ†é¡</label>
          <div id="modal-categories" class="grid grid-cols-2 gap-3">
            <!-- Radio buttons rendered by JS -->
          </div>
        </div>

        <button
          type="submit"
          id="submit-word-btn"
          disabled
          class="w-full bg-purple-500 hover:bg-purple-600 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-bold text-2xl py-4 rounded-2xl shadow-lg transition-colors mt-4 cursor-pointer"
        >
          ç¢ºèªæ–°å¢
        </button>
      </form>
    </div>
  </div>

  <script>
    // --- è³‡æ–™è¨­å®š ---
    const CATEGORIES = [
      { id: 'people', name: 'äººç‰©', icon: 'fa-user', color: 'bg-pink-100 border-pink-400 text-pink-800' },
      { id: 'subjects', name: 'ç§‘ç›®', icon: 'fa-book-open', color: 'bg-blue-100 border-blue-400 text-blue-800' },
      { id: 'places', name: 'è¨­æ–½/åœ°æ–¹', icon: 'fa-location-dot', color: 'bg-green-100 border-green-400 text-green-800' },
      { id: 'items', name: 'ç‰©å“', icon: 'fa-box', color: 'bg-yellow-100 border-yellow-400 text-yellow-800' },
      { id: 'appliances', name: 'é›»å™¨', icon: 'fa-display', color: 'bg-purple-100 border-purple-400 text-purple-800' },
      { id: 'activities', name: 'æ´»å‹•', icon: 'fa-person-running', color: 'bg-orange-100 border-orange-400 text-orange-800' }
    ];

    const INITIAL_WORDS_DATA = [
      // äººç‰©
      { text: 'è·å“¡', category: 'people' }, { text: 'æ ¡é•·', category: 'people' }, { text: 'å‰¯æ ¡é•·', category: 'people' },
      { text: 'è¨“å°ä¸»ä»»', category: 'people' }, { text: 'ç­ä¸»ä»»', category: 'people' }, { text: 'è€å¸«', category: 'people' },
      { text: 'å·¥å‹', category: 'people' }, { text: 'åŒå­¸', category: 'people' }, { text: 'é¢¨ç´€', category: 'people' },
      { text: 'å€¼æ—¥ç”Ÿ', category: 'people' }, { text: 'å­¸ç”Ÿ', category: 'people' },
      // ç§‘ç›®
      { text: 'ä¸­æ–‡', category: 'subjects' }, { text: 'è‹±æ–‡', category: 'subjects' }, { text: 'æ•¸å­¸', category: 'subjects' },
      { text: 'äººæ–‡', category: 'subjects' }, { text: 'ç§‘å­¸', category: 'subjects' }, { text: 'è¦–è¦ºè—è¡“', category: 'subjects' },
      { text: 'æ™®é€šè©±', category: 'subjects' }, { text: 'å®—æ•™', category: 'subjects' }, { text: 'éŸ³æ¨‚', category: 'subjects' },
      // è¨­æ–½/åœ°æ–¹
      { text: 'èª²å®¤', category: 'places' }, { text: 'èµ°å»Š', category: 'places' }, { text: 'æ“å ´', category: 'places' },
      { text: 'ç¦®å ‚', category: 'places' }, { text: 'éŸ³æ¨‚å®¤', category: 'places' }, { text: 'é›»è…¦å®¤', category: 'places' },
      { text: 'æ•™å“¡å®¤', category: 'places' }, { text: 'æ ¡å‹™è™•', category: 'places' }, { text: 'æ´—æ‰‹é–“', category: 'places' },
      { text: 'åœ–æ›¸é¤¨', category: 'places' }, { text: 'çª—é–€', category: 'places' }, { text: 'é»‘æ¿', category: 'places' },
      // ç‰©å“
      { text: 'ç²‰ç­†', category: 'items' }, { text: 'ç²‰æ“¦', category: 'items' },
      { text: 'é£¯ç®±', category: 'items' }, { text: 'ç­†è¢‹', category: 'items' }, { text: 'æ›¸åŒ…', category: 'items' },
      { text: 'èª²æœ¬', category: 'items' }, { text: 'æ´»åŠ›åˆé¤', category: 'items' }, { text: 'æ°´å£º', category: 'items' },
      // é›»å™¨
      { text: 'æŠ•å½±æ©Ÿ', category: 'appliances' }, { text: 'å†·æ°£æ©Ÿ', category: 'appliances' }, { text: 'é›»è…¦', category: 'appliances' },
      { text: 'æ»‘é¼ ', category: 'appliances' }, { text: 'éµç›¤', category: 'appliances' }, { text: 'é¢¨æ‰‡', category: 'appliances' },
      // æ´»å‹•
      { text: 'çœ‹åœ–æ›¸', category: 'activities' }, { text: 'åšåŠŸèª²', category: 'activities' }, { text: 'ä¸Šèª²', category: 'activities' },
      { text: 'åšæ‰‹å·¥', category: 'activities' }, { text: 'ç•«ç•«', category: 'activities' }, { text: 'å°ä¼‘', category: 'activities' },
      { text: 'å¤šå…ƒæ™ºèƒ½', category: 'activities' }, { text: 'æ’éšŠ', category: 'activities' }, { text: 'é»˜æ›¸', category: 'activities' },
      { text: 'æ¸¬é©—', category: 'activities' }, { text: 'å¯«å­—', category: 'activities' }, { text: 'å”±æ­Œ', category: 'activities' },
      { text: 'è€ƒè©¦', category: 'activities' }
    ];

    // --- ç‹€æ…‹è®Šæ•¸ ---
    let wordQueue = [];
    let activeWords = [];
    let placedWords = { people: [], subjects: [], places: [], items: [], appliances: [], activities: [] };
    
    let dragInfo = null;
    let newWordCategory = 'people';

    // éš¨æ©Ÿæ‰“äº‚é™£åˆ—
    const shuffleArray = (array) => {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    };

    // --- åˆå§‹åŒ–éŠæˆ² ---
    function initGame() {
      const shuffled = shuffleArray(INITIAL_WORDS_DATA.map((w, i) => ({ ...w, id: `word_${i}` })));
      wordQueue = shuffled.slice(5);
      activeWords = shuffled.slice(0, 5);
      placedWords = { people: [], subjects: [], places: [], items: [], appliances: [], activities: [] };
      
      renderAll();
    }

    // ç•¶æ¡Œé¢ä¸Šçš„è©èªæ¸…ç©ºæ™‚ï¼Œè‡ªå‹•è£œä¸Š 5 å€‹æ–°è©èª
    function checkAndReplenishWords() {
      if (activeWords.length === 0 && wordQueue.length > 0) {
        activeWords = wordQueue.slice(0, 5);
        wordQueue = wordQueue.slice(5);
        renderAll();
      }
    }

    // --- æ¸²æŸ“ç•«é¢ ---
    function renderAll() {
      renderHeader();
      renderCategories();
      renderWordPool();
      renderModalCategories();
    }

    function renderHeader() {
      document.getElementById('queue-count').textContent = wordQueue.length;
    }

    function renderCategories() {
      const container = document.getElementById('categories-container');
      container.innerHTML = '';

      CATEGORIES.forEach(cat => {
        const wordsHTML = placedWords[cat.id].map(word => `
          <div class="bg-white px-3 py-2 md:px-4 md:py-2 rounded-xl shadow-sm text-lg md:text-xl font-bold text-slate-700 border-2 border-opacity-20 border-current">
            ${word.text}
          </div>
        `).join('');

        const emptyHTML = placedWords[cat.id].length === 0 ? `
          <div class="w-full text-center text-current opacity-40 font-medium text-lg mt-4 border-2 border-dashed border-current rounded-xl py-4">
            è«‹æŠŠè©èªæ‹‰åˆ°é€™è£¡
          </div>
        ` : '';

        const catHTML = `
          <div id="cat-${cat.id}" data-category="${cat.id}" class="border-4 border-solid rounded-3xl p-4 flex flex-col transition-all duration-300 ${cat.color} bg-opacity-40">
            <div class="flex items-center gap-3 mb-4 border-b-2 border-current pb-2 opacity-80">
              <i class="fa-solid ${cat.icon} text-2xl drop-shadow-sm"></i>
              <h2 class="text-2xl md:text-3xl font-black tracking-wide">${cat.name}</h2>
              <span class="ml-auto bg-white bg-opacity-50 px-3 py-1 rounded-full text-lg font-bold">
                ${placedWords[cat.id].length}
              </span>
            </div>
            <div class="flex flex-wrap gap-2 md:gap-3 content-start flex-1 overflow-y-auto">
              ${wordsHTML}
              ${emptyHTML}
            </div>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', catHTML);
      });
    }

    function renderWordPool() {
      const container = document.getElementById('word-pool');
      container.innerHTML = '';

      const isGameComplete = activeWords.length === 0 && wordQueue.length === 0;

      if (isGameComplete) {
        container.innerHTML = `
          <div class="text-3xl md:text-4xl font-black text-green-500 animate-bounce flex items-center gap-4">
            ğŸ‰ æ­å–œä½ ï¼å®Œæˆæ‰€æœ‰åˆ†é¡äº†ï¼ ğŸ‰
          </div>
        `;
        return;
      }

      activeWords.forEach(word => {
        const wordEl = document.createElement('div');
        wordEl.dataset.id = word.id;
        wordEl.className = 'draggable-word touch-none px-6 py-4 md:px-8 md:py-5 rounded-2xl font-black text-2xl md:text-3xl bg-yellow-300 text-yellow-900 border-b-8 border-yellow-500 cursor-grab active:cursor-grabbing hover:bg-yellow-200 transition-all shadow-lg hover:-translate-y-1 hover:shadow-xl opacity-100';
        wordEl.textContent = word.text;
        container.appendChild(wordEl);
      });
    }

    // --- æ‹–æ›³é‚è¼¯ ---
    document.addEventListener('pointerdown', (e) => {
      const target = e.target.closest('.draggable-word');
      if (!target || e.button === 2) return; // Ignore right clicks
      
      e.preventDefault();

      const wordId = target.dataset.id;
      const word = activeWords.find(w => w.id === wordId);
      if (!word) return;

      const rect = target.getBoundingClientRect();
      dragInfo = {
        word,
        sourceEl: target,
        offsetX: e.clientX - rect.left,
        offsetY: e.clientY - rect.top,
        width: rect.width,
        height: rect.height
      };

      // Set initial position
      updateDragOverlayPosition(e.clientX, e.clientY);
      
      const overlay = document.getElementById('drag-overlay');
      overlay.textContent = word.text;
      overlay.style.width = `${dragInfo.width}px`;
      overlay.style.height = `${dragInfo.height}px`;
      overlay.classList.remove('hidden');

      // Add dashed border to categories
      document.querySelectorAll('[data-category]').forEach(el => {
        el.classList.remove('border-solid');
        el.classList.add('border-dashed');
      });

      target.classList.replace('opacity-100', 'opacity-0');
    });

    document.addEventListener('pointermove', (e) => {
      if (!dragInfo) return;
      e.preventDefault();
      updateDragOverlayPosition(e.clientX, e.clientY);
    });

    document.addEventListener('pointerup', (e) => {
      if (!dragInfo) return;

      const overlay = document.getElementById('drag-overlay');
      overlay.style.visibility = 'hidden'; // Hide to find element below

      const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
      const dropZone = elementBelow ? elementBelow.closest('[data-category]') : null;

      overlay.style.visibility = 'visible';
      overlay.classList.add('hidden'); // Hide completely now
      
      // Remove dashed border
      document.querySelectorAll('[data-category]').forEach(el => {
        el.classList.remove('border-dashed');
        el.classList.add('border-solid');
      });

      if (dropZone) {
        const categoryId = dropZone.getAttribute('data-category');
        if (categoryId === dragInfo.word.category) {
          handleCorrectDrop(dragInfo.word, categoryId);
        } else {
          handleWrongDrop(dragInfo.word);
        }
      } else {
        dragInfo.sourceEl.classList.replace('opacity-0', 'opacity-100');
      }

      dragInfo = null;
    });

    function updateDragOverlayPosition(x, y) {
      const overlay = document.getElementById('drag-overlay');
      overlay.style.left = `${x - dragInfo.offsetX}px`;
      overlay.style.top = `${y - dragInfo.offsetY}px`;
    }

    function handleCorrectDrop(word, categoryId) {
      activeWords = activeWords.filter(w => w.id !== word.id);
      placedWords[categoryId].push(word);
      
      renderAll();
      checkAndReplenishWords();

      // Visual feedback
      const catEl = document.getElementById(`cat-${categoryId}`);
      if (catEl) {
        catEl.classList.add('animate-pop', 'border-green-500', 'ring-4', 'ring-green-300');
        setTimeout(() => {
          catEl.classList.remove('animate-pop', 'border-green-500', 'ring-4', 'ring-green-300');
        }, 500);
      }
    }

    function handleWrongDrop(word) {
      dragInfo.sourceEl.classList.replace('opacity-0', 'opacity-100');
      dragInfo.sourceEl.classList.add('animate-shake', 'bg-red-400', 'border-red-600', 'text-white');
      dragInfo.sourceEl.classList.remove('bg-yellow-300', 'border-yellow-500', 'text-yellow-900');
      
      setTimeout(() => {
        if (dragInfo && dragInfo.sourceEl) return; // Guard if dragged again quickly
        const el = document.querySelector(`[data-id="${word.id}"]`);
        if (el) {
          el.classList.remove('animate-shake', 'bg-red-400', 'border-red-600', 'text-white');
          el.classList.add('bg-yellow-300', 'border-yellow-500', 'text-yellow-900');
        }
      }, 500);
    }

    // --- æ–°å¢è©èªé‚è¼¯ (Teacher Tool) ---
    const inputEl = document.getElementById('new-word-input');
    const submitBtn = document.getElementById('submit-word-btn');

    inputEl.addEventListener('input', (e) => {
      submitBtn.disabled = !e.target.value.trim();
    });

    function openAddModal() {
      document.getElementById('add-modal').classList.remove('hidden');
      inputEl.value = '';
      submitBtn.disabled = true;
      newWordCategory = 'people';
      renderModalCategories();
      setTimeout(() => inputEl.focus(), 100);
    }

    function closeAddModal() {
      document.getElementById('add-modal').classList.add('hidden');
    }

    function renderModalCategories() {
      const container = document.getElementById('modal-categories');
      container.innerHTML = CATEGORIES.map(cat => {
        const isSelected = newWordCategory === cat.id;
        return `
          <label class="flex items-center p-3 rounded-xl border-4 cursor-pointer transition-all ${isSelected ? 'border-purple-500 bg-purple-50' : 'border-slate-100 bg-slate-50 hover:bg-slate-100'}" onclick="selectCategory('${cat.id}')">
            <i class="fa-solid ${cat.icon} text-lg mr-2 ${isSelected ? 'text-purple-600' : 'text-slate-500'}"></i>
            <span class="font-bold text-lg ${isSelected ? 'text-purple-700' : 'text-slate-600'}">${cat.name}</span>
          </label>
        `;
      }).join('');
    }

    function selectCategory(id) {
      newWordCategory = id;
      renderModalCategories();
    }

    document.getElementById('add-word-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;

      const newWord = {
        id: `new_${Date.now()}`,
        text: text,
        category: newWordCategory
      };

      if (activeWords.length < 5 && wordQueue.length === 0) {
        activeWords.push(newWord);
      } else {
        wordQueue.push(newWord);
      }

      closeAddModal();
      renderAll();
      showFeedback(`å·²æˆåŠŸæ–°å¢è©èªï¼šã€Œ${text}ã€`);
    });

    function showFeedback(message) {
      const fbEl = document.getElementById('feedback-message');
      document.getElementById('feedback-text').textContent = message;
      fbEl.classList.remove('hidden');
      
      setTimeout(() => {
        fbEl.classList.add('hidden');
      }, 3000);
    }

    // --- å•Ÿå‹•éŠæˆ² ---
    document.addEventListener('DOMContentLoaded', initGame);

  </script>
</body>
</html>
